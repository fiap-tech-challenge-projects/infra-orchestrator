name: Destroy All Infrastructure

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to destroy'
        required: true
        type: choice
        options:
          - staging
          - production
      confirm:
        description: 'Type "DESTROY" to confirm'
        required: true
        type: string

env:
  AWS_REGION: 'us-east-1'

jobs:
  # ---------------------------------------------------------------------------
  # Validate Confirmation
  # ---------------------------------------------------------------------------
  validate:
    name: Validate Confirmation
    runs-on: ubuntu-latest
    steps:
      - name: Check Confirmation
        if: ${{ github.event.inputs.confirm != 'DESTROY' }}
        run: |
          echo "::error::You must type 'DESTROY' to confirm destruction"
          exit 1

      - name: Warning
        run: |
          echo "::warning::You are about to destroy ALL infrastructure in ${{ github.event.inputs.environment }}"
          echo "## DESTRUCTION CONFIRMED" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Environment: **${{ github.event.inputs.environment }}**" >> $GITHUB_STEP_SUMMARY

  # ---------------------------------------------------------------------------
  # Step 1: Destroy K8s Application (reverse order)
  # ---------------------------------------------------------------------------
  destroy-app:
    name: "1. Destroy K8s Application"
    runs-on: ubuntu-latest
    needs: validate
    # Removed continue-on-error to properly report failures
    steps:
      - name: Trigger k8s-main-service destroy
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PAT }}
          script: |
            try {
              await github.rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: 'k8s-main-service',
                workflow_id: 'deploy.yml',
                ref: '${{ github.event.inputs.environment == 'production' && 'main' || 'develop' }}',
                inputs: {
                  environment: '${{ github.event.inputs.environment }}',
                  action: 'destroy'
                }
              });
            } catch (error) {
              console.log('Could not trigger k8s-main-service destroy:', error.message);
            }

  # ---------------------------------------------------------------------------
  # Step 2: Destroy Lambda Functions
  # ---------------------------------------------------------------------------
  destroy-lambda:
    name: "2. Destroy Lambda Functions"
    runs-on: ubuntu-latest
    needs: [validate, destroy-app]
    # Removed continue-on-error to properly report failures
    steps:
      - name: Trigger lambda-api-handler destroy
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PAT }}
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: 'lambda-api-handler',
              workflow_id: 'deploy.yml',
              ref: '${{ github.event.inputs.environment == 'production' && 'main' || 'develop' }}',
              inputs: {
                environment: '${{ github.event.inputs.environment }}',
                action: 'destroy'
              }
            });

      - name: Wait for Lambda destruction
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PAT }}
          script: |
            const delay = ms => new Promise(resolve => setTimeout(resolve, ms));
            let attempts = 0;
            while (attempts < 20) {
              const runs = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: 'lambda-api-handler',
                workflow_id: 'deploy.yml',
                per_page: 1
              });
              if (runs.data.workflow_runs[0]?.status === 'completed') {
                console.log('Lambda destruction completed');
                return;
              }
              attempts++;
              await delay(30000);
            }

  # ---------------------------------------------------------------------------
  # Step 3: Destroy Database
  # ---------------------------------------------------------------------------
  destroy-database:
    name: "3. Destroy Database"
    runs-on: ubuntu-latest
    needs: [validate, destroy-lambda]
    # Removed continue-on-error to properly report failures
    steps:
      - name: Trigger database-managed-infra destroy
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PAT }}
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: 'database-managed-infra',
              workflow_id: 'terraform.yml',
              ref: '${{ github.event.inputs.environment == 'production' && 'main' || 'develop' }}',
              inputs: {
                environment: '${{ github.event.inputs.environment }}',
                action: 'destroy'
              }
            });

      - name: Wait for Database destruction
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PAT }}
          script: |
            const delay = ms => new Promise(resolve => setTimeout(resolve, ms));
            let attempts = 0;
            while (attempts < 30) {
              const runs = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: 'database-managed-infra',
                workflow_id: 'terraform.yml',
                per_page: 1
              });
              if (runs.data.workflow_runs[0]?.status === 'completed') {
                console.log('Database destruction completed');
                return;
              }
              attempts++;
              await delay(30000);
            }

  # ---------------------------------------------------------------------------
  # Step 4: Destroy EKS Infrastructure
  # ---------------------------------------------------------------------------
  destroy-eks:
    name: "4. Destroy EKS Infrastructure"
    runs-on: ubuntu-latest
    needs: [validate, destroy-database]
    steps:
      - name: Trigger kubernetes-core-infra destroy
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PAT }}
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: 'kubernetes-core-infra',
              workflow_id: 'terraform.yml',
              ref: '${{ github.event.inputs.environment == 'production' && 'main' || 'develop' }}',
              inputs: {
                environment: '${{ github.event.inputs.environment }}',
                action: 'destroy'
              }
            });

      - name: Wait for EKS destruction
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PAT }}
          script: |
            const delay = ms => new Promise(resolve => setTimeout(resolve, ms));
            let attempts = 0;
            while (attempts < 60) {
              const runs = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: 'kubernetes-core-infra',
                workflow_id: 'terraform.yml',
                per_page: 1
              });
              if (runs.data.workflow_runs[0]?.status === 'completed') {
                console.log('EKS destruction completed');
                return;
              }
              attempts++;
              await delay(30000);
            }

  # ---------------------------------------------------------------------------
  # Summary
  # ---------------------------------------------------------------------------
  summary:
    name: Destruction Summary
    runs-on: ubuntu-latest
    needs: [destroy-app, destroy-lambda, destroy-database, destroy-eks]
    if: always()
    steps:
      - name: Generate Summary
        run: |
          echo "# Infrastructure Destruction Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Environment: ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| K8s Application | ${{ needs.destroy-app.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Lambda Functions | ${{ needs.destroy-lambda.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Database (RDS) | ${{ needs.destroy-database.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| EKS Infrastructure | ${{ needs.destroy-eks.result }} |" >> $GITHUB_STEP_SUMMARY
