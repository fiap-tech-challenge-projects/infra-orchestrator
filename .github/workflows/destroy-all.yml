name: Destroy All Infrastructure

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to destroy'
        required: true
        type: choice
        options:
          - staging
          - production
      confirm:
        description: 'Type "DESTROY" to confirm'
        required: true
        type: string

env:
  AWS_REGION: 'us-east-1'

jobs:
  # ---------------------------------------------------------------------------
  # Validate Confirmation
  # ---------------------------------------------------------------------------
  validate:
    name: Validate Confirmation
    runs-on: ubuntu-latest
    steps:
      - name: Check Confirmation
        if: ${{ github.event.inputs.confirm != 'DESTROY' }}
        run: |
          echo "::error::You must type 'DESTROY' to confirm destruction"
          exit 1

      - name: Warning
        run: |
          echo "::warning::You are about to destroy ALL infrastructure in ${{ github.event.inputs.environment }}"
          echo "## DESTRUCTION CONFIRMED" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Environment: **${{ github.event.inputs.environment }}**" >> $GITHUB_STEP_SUMMARY

  # ---------------------------------------------------------------------------
  # Clean Terraform State Locks
  # ---------------------------------------------------------------------------
  clean-locks:
    name: Clean Terraform State Locks
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          # AWS_SESSION_TOKEN is optional (only required for AWS Academy)
          # If not set, it will be empty and the action will ignore it
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: us-east-1

      - name: Clean state locks
        run: |
          echo "Checking for stale Terraform state locks..."

          # Scan for locks
          locks=$(aws dynamodb scan --table-name fiap-terraform-locks --query 'Items[*].LockID.S' --output text 2>/dev/null || echo "")

          if [ -n "$locks" ]; then
            echo "Found locks to clean:"
            echo "$locks"

            # Delete each lock
            for lock in $locks; do
              if [[ "$lock" == *"${{ github.event.inputs.environment }}"* ]]; then
                echo "Deleting lock: $lock"
                aws dynamodb delete-item \
                  --table-name fiap-terraform-locks \
                  --key "{\"LockID\": {\"S\": \"$lock\"}}" 2>/dev/null || true
              fi
            done

            echo "✓ Locks cleaned"
          else
            echo "No locks found"
          fi

  # ---------------------------------------------------------------------------
  # Step 1: Destroy K8s Application (reverse order)
  # ---------------------------------------------------------------------------
  destroy-app:
    name: "1. Destroy K8s Application"
    runs-on: ubuntu-latest
    needs: [validate, clean-locks]
    continue-on-error: true
    steps:
      - name: Trigger k8s-main-service destroy
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PAT }}
          script: |
            try {
              await github.rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: 'k8s-main-service',
                workflow_id: 'deploy.yml',
                ref: '${{ github.event.inputs.environment == 'production' && 'main' || 'develop' }}',
                inputs: {
                  environment: '${{ github.event.inputs.environment }}',
                  action: 'destroy'
                }
              });
            } catch (error) {
              console.log('Could not trigger k8s-main-service destroy:', error.message);
            }

  # ---------------------------------------------------------------------------
  # Step 2: Destroy Lambda Functions
  # ---------------------------------------------------------------------------
  destroy-lambda:
    name: "2. Destroy Lambda Functions"
    runs-on: ubuntu-latest
    needs: [validate, destroy-app]
    if: always() && needs.validate.result == 'success'
    continue-on-error: true
    steps:
      - name: Trigger lambda-api-handler destroy
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PAT }}
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: 'lambda-api-handler',
              workflow_id: 'deploy.yml',
              ref: '${{ github.event.inputs.environment == 'production' && 'main' || 'develop' }}',
              inputs: {
                environment: '${{ github.event.inputs.environment }}',
                action: 'destroy'
              }
            });

      - name: Wait for Lambda destruction
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PAT }}
          script: |
            const delay = ms => new Promise(resolve => setTimeout(resolve, ms));
            let attempts = 0;
            while (attempts < 20) {
              const runs = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: 'lambda-api-handler',
                workflow_id: 'deploy.yml',
                per_page: 1
              });
              const latestRun = runs.data.workflow_runs[0];
              if (latestRun?.status === 'completed') {
                if (latestRun.conclusion === 'success') {
                  console.log('✓ Lambda destruction completed successfully');
                  return;
                } else {
                  console.log(`⚠ Lambda destruction failed: ${latestRun.conclusion}`);
                  return; // Don't throw, just log and continue
                }
              }
              attempts++;
              await delay(30000);
            }
            console.log('⚠ Lambda destruction timed out');

  # ---------------------------------------------------------------------------
  # Step 3: Destroy Database
  # ---------------------------------------------------------------------------
  destroy-database:
    name: "3. Destroy Database"
    runs-on: ubuntu-latest
    needs: [validate, destroy-lambda]
    if: always() && needs.validate.result == 'success'
    continue-on-error: true
    steps:
      - name: Trigger database-managed-infra destroy
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PAT }}
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: 'database-managed-infra',
              workflow_id: 'terraform.yml',
              ref: '${{ github.event.inputs.environment == 'production' && 'main' || 'develop' }}',
              inputs: {
                environment: '${{ github.event.inputs.environment }}',
                action: 'destroy'
              }
            });

      - name: Wait for Database destruction
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PAT }}
          script: |
            const delay = ms => new Promise(resolve => setTimeout(resolve, ms));
            let attempts = 0;
            while (attempts < 30) {
              const runs = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: 'database-managed-infra',
                workflow_id: 'terraform.yml',
                per_page: 1
              });
              const latestRun = runs.data.workflow_runs[0];
              if (latestRun?.status === 'completed') {
                if (latestRun.conclusion === 'success') {
                  console.log('✓ Database destruction completed successfully');
                  return;
                } else {
                  console.log(`⚠ Database destruction failed: ${latestRun.conclusion}`);
                  return; // Don't throw, just log and continue
                }
              }
              attempts++;
              await delay(30000);
            }
            console.log('⚠ Database destruction timed out');

  # ---------------------------------------------------------------------------
  # Step 4a: Destroy K8s Addons (Phase 2)
  # ---------------------------------------------------------------------------
  destroy-eks-addons:
    name: "4a. Destroy K8s Addons (Phase 2)"
    runs-on: ubuntu-latest
    needs: [validate, destroy-database]
    if: always() && needs.validate.result == 'success'
    continue-on-error: true
    steps:
      - name: Trigger kubernetes-addons destroy
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PAT }}
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: 'kubernetes-addons',
              workflow_id: 'terraform.yml',
              ref: '${{ github.event.inputs.environment == 'production' && 'main' || 'develop' }}',
              inputs: {
                environment: '${{ github.event.inputs.environment }}',
                action: 'destroy'
              }
            });

      - name: Wait for K8s addons destruction
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PAT }}
          script: |
            const delay = ms => new Promise(resolve => setTimeout(resolve, ms));
            let attempts = 0;
            while (attempts < 20) {
              const runs = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: 'kubernetes-addons',
                workflow_id: 'terraform.yml',
                per_page: 1
              });
              const latestRun = runs.data.workflow_runs[0];
              if (latestRun?.status === 'completed') {
                if (latestRun.conclusion === 'success') {
                  console.log('✓ K8s addons destruction completed successfully');
                  return;
                } else {
                  console.log(`⚠ K8s addons destruction failed: ${latestRun.conclusion}`);
                  return; // Don't throw, just log and continue
                }
              }
              attempts++;
              await delay(30000);
            }
            console.log('⚠ K8s addons destruction timed out');

  # ---------------------------------------------------------------------------
  # Step 4b: Destroy EKS Cluster (Phase 1)
  # ---------------------------------------------------------------------------
  destroy-eks-cluster:
    name: "4b. Destroy EKS Cluster (Phase 1)"
    runs-on: ubuntu-latest
    needs: [validate, destroy-database, destroy-eks-addons]
    if: always() && needs.validate.result == 'success'
    continue-on-error: true
    steps:
      - name: Trigger kubernetes-core-infra destroy
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PAT }}
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: 'kubernetes-core-infra',
              workflow_id: 'terraform.yml',
              ref: '${{ github.event.inputs.environment == 'production' && 'main' || 'develop' }}',
              inputs: {
                environment: '${{ github.event.inputs.environment }}',
                action: 'destroy'
              }
            });

      - name: Wait for EKS cluster destruction
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PAT }}
          script: |
            const delay = ms => new Promise(resolve => setTimeout(resolve, ms));
            let attempts = 0;
            while (attempts < 60) {
              const runs = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: 'kubernetes-core-infra',
                workflow_id: 'terraform.yml',
                per_page: 1
              });
              const latestRun = runs.data.workflow_runs[0];
              if (latestRun?.status === 'completed') {
                if (latestRun.conclusion === 'success') {
                  console.log('✓ EKS cluster destruction completed successfully');
                  return;
                } else {
                  console.log(`⚠ EKS cluster destruction failed: ${latestRun.conclusion}`);
                  return; // Don't throw, just log and continue
                }
              }
              attempts++;
              await delay(30000);
            }
            console.log('⚠ EKS cluster destruction timed out');

  # ---------------------------------------------------------------------------
  # Validate Resources Deleted
  # ---------------------------------------------------------------------------
  validate-cleanup:
    name: Validate Resources Deleted
    runs-on: ubuntu-latest
    needs: [destroy-app, destroy-lambda, destroy-database, destroy-eks-addons, destroy-eks-cluster]
    if: always()
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          # AWS_SESSION_TOKEN is optional (only required for AWS Academy)
          # If not set, it will be empty and the action will ignore it
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: us-east-1

      - name: Check for orphaned resources
        run: |
          echo "Checking for orphaned AWS resources..."

          ORPHANED_RESOURCES=0

          # Check EKS cluster
          if aws eks describe-cluster --name fiap-tech-challenge-eks-${{ github.event.inputs.environment }} --region us-east-1 &>/dev/null; then
            echo "::warning::EKS cluster still exists!"
            ORPHANED_RESOURCES=$((ORPHANED_RESOURCES + 1))
          else
            echo "✓ EKS cluster deleted"
          fi

          # Check RDS
          if aws rds describe-db-instances --db-instance-identifier fiap-tech-challenge-db-${{ github.event.inputs.environment }} --region us-east-1 &>/dev/null; then
            echo "::warning::RDS instance still exists!"
            ORPHANED_RESOURCES=$((ORPHANED_RESOURCES + 1))
          else
            echo "✓ RDS instance deleted"
          fi

          # Check VPC
          vpc_id=$(aws ec2 describe-vpcs \
            --filters "Name=tag:Project,Values=fiap-tech-challenge" "Name=tag:Environment,Values=${{ github.event.inputs.environment }}" \
            --region us-east-1 \
            --query 'Vpcs[0].VpcId' \
            --output text 2>/dev/null || echo "None")

          if [ "$vpc_id" != "None" ] && [ -n "$vpc_id" ]; then
            echo "::warning::VPC still exists: $vpc_id"
            echo "::warning::Run cleanup script: ./scripts/cleanup-aws-resources.sh ${{ github.event.inputs.environment }}"
            ORPHANED_RESOURCES=$((ORPHANED_RESOURCES + 1))
          else
            echo "✓ VPC deleted"
          fi

          # Report summary
          if [ $ORPHANED_RESOURCES -gt 0 ]; then
            echo ""
            echo "::error::Found $ORPHANED_RESOURCES orphaned resource(s)"
            echo "::error::Manual cleanup required. Run: ./scripts/cleanup-aws-resources.sh ${{ github.event.inputs.environment }}"
            exit 1
          else
            echo ""
            echo "✓ All resources successfully deleted"
          fi

  # ---------------------------------------------------------------------------
  # Summary
  # ---------------------------------------------------------------------------
  summary:
    name: Destruction Summary
    runs-on: ubuntu-latest
    needs: [destroy-app, destroy-lambda, destroy-database, destroy-eks-addons, destroy-eks-cluster, validate-cleanup]
    if: always()
    steps:
      - name: Generate Summary
        run: |
          echo "# Infrastructure Destruction Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Environment: ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| K8s Application | ${{ needs.destroy-app.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Lambda Functions | ${{ needs.destroy-lambda.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Database (RDS) | ${{ needs.destroy-database.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| K8s Addons (Phase 2) | ${{ needs.destroy-eks-addons.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| EKS Cluster (Phase 1) | ${{ needs.destroy-eks-cluster.result }} |" >> $GITHUB_STEP_SUMMARY
